#!/bin/bash
set -e

# === Load Configuration ===
source ./config.txt

mkdir -p "$DBPATH"

# === FUNCTIONS ===

download_and_extract() {
    echo "‚è¨ Downloading MongoDB server..."
    wget -O mongodb.tgz "$MONGO_URL"
    tar -xzf mongodb.tgz
    mv mongodb-linux-* "$MONGO_DIR"
    rm mongodb.tgz
    echo "‚úÖ MongoDB server ready."

    echo "‚è¨ Downloading Mongo Shell (mongosh)..."
    wget -O mongosh.tgz "$MONGOSH_URL"
    tar -xzf mongosh.tgz
    mv mongosh-* "$MONGOSH_DIR"
    rm mongosh.tgz
    echo "‚úÖ Mongo Shell ready."
}

start_mongod() {
    echo "üöÄ Starting MongoDB server..."
    "$MONGO_BIN/mongod" --dbpath "$DBPATH" --fork --logpath "$DBPATH/mongod.log"
    sleep 5  # give it time to fully start
}

setup_database() {
    echo "‚öôÔ∏è Creating database '$DB_NAME' and collection '$COLLECTION_NAME'..."
    "$MONGOSH_BIN/mongosh" <<EOF
use $DB_NAME
db.createCollection("$COLLECTION_NAME")
EOF
}

import_data() {
    echo "üì¶ Importing JSON data into '$DB_NAME.$COLLECTION_NAME'..."
    "$MONGO_BIN/mongoimport" --db "$DB_NAME" --collection "$COLLECTION_NAME" --file "$JSON_FILE" --jsonArray
}

# === MAIN SCRIPT ===

echo "üöÄ MongoDB Portable Installer Script Started"

download_and_extract
start_mongod
setup_database
import_data

echo "üéâ All operations completed successfully!"
read -p "Press [Enter] to close..."
